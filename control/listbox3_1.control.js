/*! controller 27-01-2016 */
function kitchenCheck(){this.teachersurl="http://115.28.141.223:89/WebServices/KMService.ashx?Option=GetWorkerExtension&",this.checklisturl="http://115.28.141.223:89/WebServices/KMService.ashx?Option=GetKitchenCheckItem&",this.sendurl=" http://115.28.141.223:89/WebServices/KMService.ashx?Option=SaveKMKitchenCheck",this.editmesurl="http://115.28.141.223:89/WebServices/KMService.ashx?Option=GetKMKitchenCheckById&KitchenCheckId=",this.userMes=JSON.parse(plus.storage.getItem("userMes")),this.kgid=this.userMes.KgId,this.userName=this.userMes.Name,this.userId=this.userMes.UserId,this.DataDictionaryType="KitchenCheckType",this.kitchencheckid=0,this.prekitchencheckid=1,this.teacherlist=document.getElementById("teacherslist"),this.checktable=document.getElementById("check_Table"),this.senbtn=document.getElementById("sendbtn"),this.wating=""}mui.init(),mui.plusReady(function(){var a=plus.webview.currentWebview(),b=a.action,c=new kitchenCheck;"new"==b?(c.initNew(),c.sendBtnTap()):"edit"==b&&(c.initEdit(),c.sendBtnTap("edit"))}),kitchenCheck.prototype.initNew=function(){this.ajaxGetTeacherList(),this.ajaxGetChecklist()},kitchenCheck.prototype.initRadioParentBk=function(){for(this.radioinput=document.querySelectorAll('input[type="radio"]'),this.radiosspan=document.querySelectorAll(".radio_span"),i=0;i<this.radioinput.length;i++)this.radioinput[i].checked===!0?this.radioinput[i].parentElement.style.background="#F0AD4E":this.radioinput[i].parentElement.style.background="none"},kitchenCheck.prototype.setTapRadioParentBK=function(){function a(a){for(i=0;i<a.length;i++)1==a[i].checked?a[i].parentElement.style.background="#F0AD4E":a[i].parentElement.style.background="none"}var b=this;for(i=0;i<b.radioinput.length;i++)b.radioinput[i].addEventListener("change",function(){var b=this.getAttribute("name"),c=document.querySelectorAll('input[name="'+b+'"]');a(c)},!1)},kitchenCheck.prototype.ajaxGetTeacherList=function(a){var b=this;b.wating=plus.nativeUI.showWaiting(),mui.ajax(this.teachersurl+"KgId="+this.kgid,{dataType:"json",type:"get",timeout:5e3,success:function(c){b.wating.close(),1e4==c.Success&&b.addTeacherList(b.teacherlist,c.RerurnValue,a)},error:function(){b.wating.close(),mui.alert("获取检查人失败，请检查网络","提示")}})},kitchenCheck.prototype.addTeacherList=function(a,b,c){var d,e=b.length;for(i=0;i<e;i++)d+=c&&b[i].WorkerExtensionId==c?'<option value="'+b[i].WorkerExtensionId+'" selected>'+b[i].Name+"</option>":'<option value="'+b[i].WorkerExtensionId+'" >'+b[i].Name+"</option>";a.innerHTML+=d},kitchenCheck.prototype.ajaxGetChecklist=function(a){var b=this;b.wating=plus.nativeUI.showWaiting(),mui.ajax(this.checklisturl+"KgId="+this.kgid+"&KitchenCheckType=KitchenCheckType",{dataType:"json",type:"get",timeout:5e3,success:function(c){b.wating.close(),1e4==c.Success&&(b.addCheckList(c.RerurnValue,a),b.initRadioParentBk(),b.setTapRadioParentBK())},error:function(){mui.alert("请求超时，请检查网络","提示")}})},kitchenCheck.prototype.addCheckList=function(a,b){var c=a.length,d="";if(b)for(i=0;i<c;i++)d+='<tr><td width="25%">'+a[i].DataDictionaryName+'</td><td width="20%">',1==b[i].CheckResult?(d+='<label><span class="radio_span"><input type="radio" hidden="hidden" checked="checked" name="CheckResult'+i+'" value="1" />合格</span></label>',d+='</td><td width="20%"><label><span class="radio_span"><input type="radio" hidden="hidden" name="CheckResult'+i+'" value="0" />不合格</span></label>'):(d+='<label><span class="radio_span"><input type="radio" hidden="hidden"  name="CheckResult'+i+'" value="1" />合格</span></label>',d+='</td><td width="20%"><label><span class="radio_span"><input type="radio" checked="checked" hidden="hidden" name="CheckResult'+i+'" value="0" />不合格</span></label>'),d+='</td><td width="35%"><input type="text" name="description'+i+'" value="'+b[i].Description+'"  class="bz_text"/><input  hidden="hidden"  name="DataDictionaryId"  value="'+a[i].DataDictionaryId+'" /></td></tr>';else for(i=0;i<c;i++)d+='<tr><td width="25%">'+a[i].DataDictionaryName+'</td><td width="20%">',d+='<label><span class="radio_span"><input type="radio" hidden="hidden" checked="checked" name="CheckResult'+i+'" value="1" />合格</span></label>',d+='</td><td width="20%"><label><span class="radio_span"><input type="radio" hidden="hidden" name="CheckResult'+i+'" value="0" />不合格</span></label>',d+='</td><td width="35%"><input type="text" name="description'+i+'" value=""  class="bz_text"/><input  hidden="hidden"  name="DataDictionaryId"  value="'+a[i].DataDictionaryId+'" /></td></tr>';this.checktable.innerHTML+=d},kitchenCheck.prototype.geSendArrValue=function(a){var b,c=this,d="",e=[],f=this.checktable.querySelectorAll("tr"),g=f.length;for(b=a?c.prekitchencheckid:c.kitchencheckid,i=0;i<g;i++){var h=parseInt(f[i].querySelector('input[name="DataDictionaryId"]').value),j=parseInt(f[i].querySelector('input[type="radio"]:checked').value),k=f[i].querySelector('input[name="description'+i+'"]').value,l={KitchenCheckDetailId:h,KitchenCheckId:b,KMItemId:h,CheckResult:j,Description:k};e.push(l)}e=JSON.stringify(e);var m,n,o,p=c.teacherlist.value,q=c.teacherlist.options[c.teacherlist.selectedIndex].text,r=new Date,s=r.Format("yyyy-MM-ddThh:mm:ss");return a?(m='"Creator":"'+a.Creator+'","CreatorId":'+a.CreatorId+',"CreateDate":"'+a.CreateDate+'",',n='"ExaminatorName":"'+a.ExaminatorName+'","ExaminatorId":'+a.ExaminatorId+',"CheckDate":"'+a.CheckDate+'",',o='"Modifier":"'+q+'","ModifyId":'+p+',"ModifyDate":"'+s+'"}'):(m='"Creator":"'+c.userName+'","CreatorId":'+c.userId+',"CreateDate":"'+s+'",',n='"ExaminatorName":"'+q+'","ExaminatorId":'+p+',"CheckDate":"'+s+'",',o='"Modifier":"","ModifyId":0,"ModifyDate":"'+s+'"}'),d='{"kMKitchenCheckDetailList":'+e+',"KitchenCheckId":'+b+',"OrganizationId":'+c.kgid+","+d+m+n+o},kitchenCheck.prototype.sendBtnTap=function(a){var b=this;b.senbtn.addEventListener("tap",function(){"edit"==a?b.ajaxSendCheckMES(b.editMes):b.ajaxSendCheckMES()},!1)},kitchenCheck.prototype.ajaxSendCheckMES=function(a){var b=this,c=b.teacherlist.value;if(!c)return void mui.alert("请选择检查人","提示");var d;d=a?b.geSendArrValue(a):b.geSendArrValue(),d=d,b.wating=plus.nativeUI.showWaiting(),mui.ajax(b.sendurl,{type:"post",dataType:"json",data:{jsonStr:d},timeout:5e3,success:function(a){if(b.wating.close(),1e4==a.Success){a.RerurnValue.toString();plus.storage.setItem("chencheckid",a.RerurnValue.toString()),mui.alert("提交成功！","提示",function(){mui.back()})}},error:function(){b.wating.close(),mui.alert("提交失败！","提示")}})},kitchenCheck.prototype.initEdit=function(){this.ajaxGetEditMes()},kitchenCheck.prototype.ajaxGetEditMes=function(){var a=this;return a.prekitchencheckid?(a.wating=plus.nativeUI.showWaiting(),void mui.ajax(a.editmesurl+"1",{type:"get",dataType:"json",timeout:5e3,success:function(b){a.wating.close(),1e4==b.Success&&(a.ajaxGetTeacherList(b.RerurnValue.ExaminatorId),a.ajaxGetChecklist(b.RerurnValue.kMKitchenCheckDetailList),a.editMes=b.RerurnValue)},error:function(){a.wating.close(),mui.alert("请求超时，请检查网络","提示")}})):void mui.alert("请新建一项才能编辑","提示",function(){mui.back()})};